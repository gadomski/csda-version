name: Bump version

on:
  schedule:
    - cron: "0 0 * * 0" # Every Sunday at midnight UTC

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: check
        name: Check if bi-weekly run
        run: |
          week=$(date +%V)
          if [ $((week % 2)) -eq 0 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - if: steps.check.outputs.should_run == 'true'
        uses: astral-sh/setup-uv@v7

      - if: steps.check.outputs.should_run == 'true'
        id: bump
        name: Update version
        run: |
          current=$(cat csda-version.txt)
          new_version=$(uv run csda-version next-csda-version "$(date +%Y-%m-%d)" "$current")
          echo "$new_version" > csda-version.txt
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - if: steps.check.outputs.should_run == 'true'
        name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.txt
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push
